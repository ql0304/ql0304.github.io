# 加速算法
why：在光线追踪算法中，我们需要判断一根光线是否与场景中的物体相交。若没有加速算法，我们只能把光线与场景中的物体逐个求交来判断是否有交点。当场景中物体数量较多或是光线数量较多的时候，计算量是非常恐怖的，因此需要一个光线与场景求交的加速算法。

what：加速算法包含了两个步骤：

1. 划分场景(划分对象 或 划分空间)；
2. 与子场景求交：若没有交点return false；若有交点，再判断是否与子场景中的物体是否有交点。

## BVH

what：是划分对象的算法，广泛应用在光线追踪中。

how：

建树：BVH树的所有节点都是一个AABB包围盒，根节点的轴对齐包围盒包含了场景中的所有对象。把根节点划分为两个子包围盒，在x,y,z中随机选择一个轴，把包围盒中的对象按该轴排序，选择中间的对象为分界点，划分左右两边的对象。再对每一个子包围盒做上述操作，直到包围盒中只剩1个对象。

求交：首先计算光线与根包围盒是否有交点。若无交点，说明光线与整个场景都没有交点，return；若有交点，那么光线与左右孩子相交都有可能，所以要与与左右孩子求交并遍历其子树，如果与孩子没交点，自然整颗子树都可以舍弃。**求交次数为O(h)**

### 1.求交算法

为了方便求交，此处使用轴对齐包围盒AABB。

AABB由3个“对面”组成（x0,x1）（y0,y1）（z0,z1）

求光线与一对X平面的交点，将先进入的交点(偏小的那个)记为 $t_{min}$, 后出去的交点(偏大的那个)记为 $t_{max}$

对Y和Z同理。

$t_{enter}=max\left\{t_{min}\right\}$         $t_{exit}=min\left\{t_{max}\right\}$    t是负值也无所谓。

光线与包围盒相交 当且仅当   $t_{enter}<t_{exit}$   &&     $t_{exit}>=0$

### 2.划分场景

1. 可以每次随机指定一个轴，把物体按该轴进行排序，从中间划分为两部分
2. 可以每次选择最长的那个轴，从中间划为两部分

### BVH树的应用

- 碰撞检测(每个三角形之间的碰撞)

在Bullet、Havok等物理引擎的碰撞粗测阶段，使用一种叫做 **动态层次AABB包围盒树(Dynamic Bounding Volume Hierarchy Based On AABB Tree)** 的结构来存储动态的AABB形状。然后通过该包围盒树的性质（不同父包围盒必定不会碰撞），快速过滤大量不可能发生碰撞的形状对。

- 射线检测/挑选几何体

射线检测从层次包围盒树自顶向下检测是否射线通过包围盒，若不通过则无需检测其子包围盒。这种剪裁可让每次射线检测平均只需检测O(logN)数量的形状。通过一个点位置快速挑选该点的几何体也是类似的原理。

- 视锥剔除

对BVH树进行中序遍历的视锥测试，如果一个节点所代表的包围盒不在视锥范围内，那么其所有子节点所代表的包围盒都不会在视锥范围内，则可以跳过测试其子节点。在这个遍历过程中，通过测试的节点所代表的几何体才可以发送渲染命令。

- 辅助BSP树构建

在BSP树的构建中，利用球体树辅助，可以将复杂度从O(Nlog²N)下降为O(NlogN)的复杂度。

## Octree

what：划分空间的算法，广泛应用在游戏中

每次将空间分为8个相等的部分，再递归的对子空间进行划分。当划分的**子空间足够小**或是**空间中三角形面的数量很少**的时候会停止划分。这种方法的显著缺点是，随着维度的上升划分的空间数量会呈指数级增长。

## BVH树和八叉树的区别

**游戏引擎一般用八叉树做场景管理，BVH一般用在光线追踪上面。**

BVH实现起来比八叉树稍微麻烦一点，八叉树只需要知道场景的大小和模型的精度就能进行分割，然后将模型一个个塞进去即可，而BVH需要了解全部的模型信息才能进行下一步分割。而且游戏场景一般都分布比较均匀（一大片空地的情况少见），上图中物体集中在某一区域的情况比较少，所以利用八叉树和BVH树的层数和效率应该是差不多的。

BVH的构建比较耗时间，而且对于动态物体的支持比较麻烦，但是运行效率会更高，因此常用于离线渲染和光线追踪等对性能要求较高的场合。

八叉树的构建简洁明了，比较直观。八叉树的结构是固定的，不会受物体位置的影响，这样对动态物体非常友好，因此比较适合在游戏中使用。

## Kd-tree

what：空间划分算法

其每次将空间划分为两部分，且划分依次沿着x-axis，y-axis，z-axis，划分过程遵循几个点：

1. **依次沿着x-axis,y-axis,z-axis划分，使得空间被划分的更加平衡**
2. **划分的位置由空间中三角面的分布决定，具体细节不展开**
3. **叶子节点存储对应空间的所有物体或三角面信息，中间节点仅存储指针指向两个子空间**
4. **当划分空间太小或是子空间内只有少量三角形则停止划分**

**优点：** 利用KD-Tree的结构来构建AABB的好处是倘若光线与哪一部分空间不相交，那么则可以省略该部分空间所有子空间的判断过程，在原始的纯粹的AABB之上更进一步提升了加速效率。

**缺点：** 缺点是判断包围盒与三角面的是否相交较难，因此划分的过程不是那么想象的简单，其次同一个三角面可能被不同的包围盒同时占有，这两个不同包围盒内的叶节点会同时存储这一个三角形面